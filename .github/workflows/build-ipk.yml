# <https://github.com/KFERMercer/OpenWrt-CI>
# Copyright (C) 2019 P3TERX
# Copyright (C) 2020 KFERMercer
name: Build CoovaChilli-FreeRADIUS3 (Mi AC2100)

on:
  schedule:
    - cron: '0 20 * * *'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build_packages:
    name: Build for Xiaomi AC2100 (MT7621)
    runs-on: ubuntu-22.04

    steps:
      # 1. 清理环境+安装编译依赖
      - name: Clean space and init environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          docker rmi `docker images -q`
          sudo -E rm -rf /usr/share/dotnet /etc/mysql /etc/php /etc/apt/sources.list.d /usr/local/lib/android
          sudo -E apt-mark hold grub-efi-amd64-signed
          sudo -E apt update
          sudo -E apt -y purge azure-cli* docker* ghc* zulu* llvm* firefox google* dotnet* powershell* openjdk* mysql* php* mongodb* dotnet* snap*
          sudo -E apt -y full-upgrade
          # 安装完整依赖（含OpenSSL/ca-bundle相关）
          sudo -E apt -y install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential bzip2 ccache clang cmake cpio curl device-tree-compiler flex gawk gcc-multilib g++-multilib gettext genisoimage git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev libssl-dev libtool llvm lrzsz msmtp ninja-build p7zip p7zip-full patch pkgconf python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev ca-certificates libssl-dev libpam0g-dev
          sudo -E systemctl daemon-reload
          sudo -E apt -y autoremove --purge
          sudo -E apt clean
          sudo -E timedatectl set-timezone "Asia/Shanghai"

      # 2. 额外释放磁盘空间
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          swap-storage: true

      # 3. 拉取OpenWrt完整源码（替代SDK，解决Makefile缺失问题）
      - name: Checkout OpenWrt full source (23.05)
        uses: actions/checkout@v4
        with:
          repository: openwrt/openwrt
          ref: openwrt-23.05
          path: openwrt

      # 4. 修复feeds源（补全缺失的依赖包）
      - name: Fix feeds and install dependencies
        run: |
          cd openwrt
          # 补全所有核心feeds（解决ca-bundle/libopenssl缺失）
          echo "src-git base https://git.openwrt.org/openwrt/openwrt.git;openwrt-23.05" > feeds.conf.default
          echo "src-git packages https://git.openwrt.org/feed/packages.git;openwrt-23.05" >> feeds.conf.default
          echo "src-git luci https://git.openwrt.org/project/luci.git;openwrt-23.05" >> feeds.conf.default
          echo "src-git routing https://git.openwrt.org/feed/routing.git;openwrt-23.05" >> feeds.conf.default
          echo "src-git telephony https://git.openwrt.org/feed/telephony.git;openwrt-23.05" >> feeds.conf.default
          
          # 更新并安装所有基础依赖（解决unbound/ca-bundle/libopenssl缺失）
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          ./scripts/feeds install ca-bundle libopenssl openssl-util libpam libmysqlclient libpq libldap libsasl2 libtalloc libnettle

      # 5. 拉取带OpenWrt Makefile的coova-chilli/freeradius3（核心修复）
      - name: Pull packages with OpenWrt Makefile
        run: |
          cd openwrt
          # ===== 替换1：使用OpenWrt官方维护的coova-chilli（带标准Makefile）=====
          rm -rf package/feeds/packages/coova-chilli
          git clone -b openwrt-23.05 https://github.com/openwrt/packages.git tmp-packages
          cp -rf tmp-packages/net/coova-chilli package/feeds/packages/
          # 回退到coova-chilli 1.8版本（匹配你的需求）
          cd package/feeds/packages/coova-chilli
          git init
          git remote add origin https://github.com/coova/coova-chilli.git
          git fetch origin 1.8
          git checkout 1.8
          cd ../../../../

          # ===== 替换2：使用OpenWrt官方的freeradius3（带标准Makefile）=====
          ./scripts/feeds install freeradius3

      # 6. 配置小米AC2100编译环境（仅编译指定包）
      - name: Configure for Xiaomi AC2100
        run: |
          cd openwrt
          rm -f ./.config*
          touch ./.config
          cat >> .config <<EOF
          # 小米AC2100硬件配置
          CONFIG_TARGET_ramips=y
          CONFIG_TARGET_ramips_mt7621=y
          CONFIG_TARGET_ramips_mt7621_DEVICE_xiaomi_mi-router-ac2100=y
          CONFIG_TARGET_ARCH_PACKAGES="mipsel_24kc"
          CONFIG_CPU_TYPE="24kc"
          
          # 启用必需依赖（解决unbound/ca-bundle警告）
          CONFIG_PACKAGE_ca-bundle=y
          CONFIG_PACKAGE_libopenssl=y
          CONFIG_PACKAGE_openssl-util=y
          
          # 仅编译目标包（禁用系统镜像）
          CONFIG_BUILD_OPTIONAL=y
          CONFIG_PACKAGE_coova-chilli=y
          CONFIG_PACKAGE_freeradius3=y
          CONFIG_PACKAGE_freeradius3-common=y
          CONFIG_PACKAGE_freeradius3-utils=y
          CONFIG_PACKAGE_freeradius3-radclient=y
          
          # 禁用所有系统镜像输出（只编译ipk）
          CONFIG_TARGET_IMAGES_GZIP=n
          CONFIG_TARGET_ROOTFS_TARGZ=n
          CONFIG_TARGET_ROOTFS_SQUASHFS=n
          EOF
          # 生成配置（自动补全依赖）
          make defconfig

      # 7. 下载所有依赖包（含ca-bundle/libopenssl）
      - name: Download all dependencies
        run: |
          cd openwrt
          make download -j16

      # 8. 编译coova-chilli和freeradius3（修复No rule错误）
      - name: Compile target packages
        run: |
          cd openwrt
          # 先编译依赖包（ca-bundle/libopenssl）
          make package/ca-bundle/compile V=s
          make package/libopenssl/compile V=s
          # 再编译目标包
          make package/coova-chilli/compile V=s
          make package/freeradius3/compile V=s
          # 输出产物路径
          echo "===== Compiled IPKs ====="
          find ./bin/packages/mipsel_24kc/ -name "coova-chilli*.ipk"
          find ./bin/packages/mipsel_24kc/ -name "freeradius3*.ipk"

      # 9. 整理产物
      - name: Prepare artifacts
        run: |
          mkdir -p ./artifact/packages
          # 复制小米AC2100可用的ipk包
          cp -rf $(find ./openwrt/bin/packages/mipsel_24kc/ -name "coova-chilli*.ipk") ./artifact/packages/
          cp -rf $(find ./openwrt/bin/packages/mipsel_24kc/ -name "freeradius3*.ipk") ./artifact/packages/
          # 复制依赖包
          cp -rf $(find ./openwrt/bin/packages/mipsel_24kc/ -name "ca-bundle*.ipk") ./artifact/packages/
          cp -rf $(find ./openwrt/bin/packages/mipsel_24kc/ -name "libopenssl*.ipk") ./artifact/packages/

      # 10. 上传产物
      - name: Upload IPK Packages
        uses: actions/upload-artifact@v4
        with:
          name: Xiaomi-AC2100-coovachilli-freeradius3-ipk
          path: ./artifact/packages/
