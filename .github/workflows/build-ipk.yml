name: Build CoovaChilli 1.8 and FreeRADIUS

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout CoovaChilli 1.8
      uses: actions/checkout@v4
      with:
        repository: coova/coova-chilli
        ref: 1.8
        path: coova-chilli

    - name: Checkout FreeRADIUS Server
      uses: actions/checkout@v4
      with:
        repository: FreeRADIUS/freeradius-server
        path: freeradius-server

    - name: Install dependencies
      run: |
        sudo apt-get update
        # 通用依赖
        sudo apt-get install -y build-essential autoconf automake libtool pkg-config
        # CoovaChilli 依赖
        sudo apt-get install -y libssl-dev libpcre3-dev iptables-dev
        # FreeRADIUS 依赖
        sudo apt-get install -y libtalloc-dev libkqueue-dev libssl-dev libpcap-dev \
                                 libgdbm-dev libldap2-dev libmysqlclient-dev libpq-dev \
                                 libkrb5-dev libperl-dev python3-dev

    - name: Build CoovaChilli 1.8
      run: |
        cd coova-chilli
        sh bootstrap
        ./configure --prefix=/usr/local/coova-chilli
        make -j$(nproc)
        sudo make install

    - name: Build FreeRADIUS Server
      run: |
        cd freeradius-server
        ./configure --prefix=/usr/local/freeradius
        make -j$(nproc)
        sudo make install

    - name: Verify installations
      run: |
        /usr/local/coova-chilli/bin/chilli --version
        /usr/local/freeradius/sbin/radiusd -v
